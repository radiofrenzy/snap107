<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SNAP 107 - LIVE</title>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">

<style>
/* KEEP YOUR EXISTING CSS */
body { background-color: #020210; color: #7898FB; font-family: 'DotGothic16', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; padding: 0 20px; gap: 15px; overflow: hidden; }
#blur-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; filter: blur(50px) brightness(0.35); z-index: 0; transition: background-image 1s ease, filter 1s ease; }
#player-widget, #history-widget { height: 380px; background: linear-gradient(145deg, #050525, #0a0a35); border: 3px solid #1a1a40; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); position: relative; z-index: 1; }
#player-widget { flex: 1.5 1 0; min-width: 700px; padding: 20px 25px; display: flex; flex-direction: column; position: relative; }
#history-widget { flex: 1.2 1 0; min-width: 600px; padding: 20px; display: flex; flex-direction: column; }
.live-tag { position: absolute; top: 15px; left: 20px; font-size: 12px; color: #ff3333; font-weight: bold; letter-spacing: 1px; animation: blink 1.5s infinite; }
@keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
#player-content { display: flex; gap: 25px; align-items: center; flex-grow: 1; }
#album-art { width: 220px; height: 220px; object-fit: cover; border-radius: 12px; border: 2px solid #1a1a40; }
#text-info { display: flex; flex-direction: column; justify-content: center; flex-grow: 1; overflow: hidden; }
.marquee-container { overflow: hidden; white-space: nowrap; margin-bottom: 2px; }
#artist { font-size: 17px; opacity: 0.8; }
#title { font-size: 38px; color: #a0baff; text-shadow: 0 0 15px rgba(120,152,251,.5); line-height: 1.1; font-weight: bold; }
.btn-request { margin-top: 15px; padding: 6px 12px; border: 1px solid #7898FB; color: #7898FB; text-decoration: none; font-size: 13px; width: fit-content; text-transform: uppercase; }
.history-header { font-size: 18px; color: #fff; font-weight: bold; margin-bottom: 12px; border-bottom: 2px solid #1a1a40; padding-bottom: 8px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
#date-tabs { display: flex; gap: 5px; margin-left: auto; }
.date-tab { background: #1a1a40; padding: 2px 6px; border-radius: 4px; font-size: 12px; cursor: pointer; color: #7898FB; transition: 0.2s; }
.date-tab.active { background: #2EF049; color: #020210; font-weight: bold; }
#tracks-inner { flex-grow: 1; overflow-y: auto; font-size: 15.5px; color: #a0baff; font-weight: bold; }
.history-item { display: flex; gap: 10px; margin-bottom: 8px; border-bottom: 1px solid #080828; padding-bottom: 4px; }
.history-time { color: #3a3a6a; min-width: 50px; }
.history-item:first-child { font-weight: bold; font-size: 17px; }
.history-item:first-child span:nth-child(2) { color: #2EF049; text-shadow: 0 0 8px #2EF049; }
#page-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
#top-row { display: flex; gap: 15px; width: 100%; max-width: 2200px; }
#caster-container { width: 100%; max-width: 1600px; padding: 20px; background: #050525; border: 3px solid #1a1a40; border-radius: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
</style>
</head>

<body>
<div id="blur-bg"></div>

<div id="page-wrapper">

<div id="top-row">

<div id="player-widget">
<span class="live-tag">● LIVE</span>

<div id="player-content">
<img id="album-art" src="https://via.placeholder.com/600x600/000/7898FB?text=SNAP+107">
<div id="text-info">
<div class="marquee-container"><div id="artist">STATION</div></div>
<div class="marquee-container"><div id="title">SNAP 107</div></div>
<a href="#" class="btn-request">REQUEST SONG</a>
</div>
</div>
</div>

<div id="history-widget">
<div class="history-header">
    <span id="current-date">7-DAY RADIO LOG</span>
    <div id="date-tabs"></div>
</div>
<div id="tracks-inner">CONNECTING...</div>
</div>

</div>

<div id="caster-container">
<div data-type="newStreamPlayer"
data-publicToken="68bebccc-3f3d-406f-84e0-10e7cfe152d5"
data-theme="dark"
data-color="1E3BE8"
class="cstrEmbed">
<a href="https://www.caster.fm">Shoutcast Hosting</a>
<a href="https://www.caster.fm">Stream Hosting</a>
<a href="https://www.caster.fm">Radio Server Hosting</a>
</div>
</div>

</div>

<script src="//cdn.cloud.caster.fm/widgets/embed.js"></script>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.25.0/firebase-firestore-compat.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  /* -------- FIREBASE INIT -------- */
  const firebaseConfig = {
    apiKey: "AIzaSyAAbYsWAjxCc-k1ccEhdP4sk5KWhcqykD8",
    authDomain: "snap107-radiolog.firebaseapp.com",
    projectId: "snap107-radiolog",
    storageBucket: "snap107-radiolog.firebasestorage.app",
    messagingSenderId: "48538616273",
    appId: "1:48538616273:web:26b458348581938bdc60f0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* -------- MAKE logTrack GLOBAL -------- */
  window.logTrack = async (title) => {
    await db.collection('radio_history').add({
      track_title: title,
      created_at: firebase.firestore.FieldValue.serverTimestamp()
    });
    updateDisplay();
  };

  /* -------- UTILITY -------- */
  function getDateKey(date = new Date()) {
    const d = date;
    return `${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
  }

  let daySections = {};
  let currentSongInLog = "";
  let currentTab = getDateKey();

  /* -------- RENDER TABS -------- */
  function renderTabs() {
    const container = document.getElementById('date-tabs');
    container.innerHTML = '';
    const keys = Object.keys(daySections).sort((a,b)=>{
      const [am, ad] = a.split('.').map(Number);
      const [bm, bd] = b.split('.').map(Number);
      return bm*31 + bd - (am*31 + ad);
    }).slice(-7);

    keys.forEach(key=>{
      const tab = document.createElement('div');
      tab.className = 'date-tab' + (key===currentTab?' active':'');
      tab.innerText = key;
      tab.onclick = () => { currentTab = key; renderTabs(); renderTracks(); };
      container.appendChild(tab);
    });
  }

  /* -------- RENDER TRACKS -------- */
  function renderTracks() {
    const container = document.getElementById('tracks-inner');
    const tracks = daySections[currentTab] || [];
    container.innerHTML = tracks.map(d=>`
      <div class="history-item">
        <span class="history-time">[${d.time}]</span>
        <span>${d.track_title}</span>
      </div>
    `).join('');
  }

  /* -------- GET COVER ART -------- */
  async function getCover(artist, title){
    try {
      const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(artist+' '+title)}&entity=song&limit=1`);
      const data = await res.json();
      return data.results?.[0]?.artworkUrl100?.replace('100x100','600x600') || "https://via.placeholder.com/600x600/000/7898FB?text=SNAP+107";
    } catch {
      return "https://via.placeholder.com/600x600/000/7898FB?text=SNAP+107";
    }
  }

  /* -------- UPDATE DISPLAY -------- */
  async function updateDisplay() {
    const snapshot = await db.collection('radio_history')
      .orderBy('created_at','desc')
      .limit(30)
      .get();

    daySections = {};
    snapshot.docs.forEach(doc=>{
      const d = doc.data();
      const timeObj = d.created_at?.toDate() || new Date();
      const dayKey = getDateKey(timeObj);
      if(!daySections[dayKey]) daySections[dayKey] = [];
      const timeStr = `${String(timeObj.getHours()).padStart(2,'0')}:${String(timeObj.getMinutes()).padStart(2,'0')}`;
      if(!daySections[dayKey].some(t=>t.track_title===d.track_title && t.time===timeStr)){
        daySections[dayKey].push({track_title:d.track_title, time:timeStr});
      }
    });

    renderTabs();
    renderTracks();

    const topTrack = snapshot.docs[0]?.data().track_title?.trim();
    if(topTrack && topTrack !== currentSongInLog){
      currentSongInLog = topTrack;
      const [artist, title] = topTrack.split(/ - | – /);
      document.getElementById('artist').innerText = artist || "SNAP 107";
      document.getElementById('title').innerText = title || artist;

      const albumUrl = await getCover(artist||"", title||"");
      document.getElementById('album-art').src = albumUrl;
      document.getElementById('blur-bg').style.backgroundImage = `url(${albumUrl})`;
    }
  }

  /* -------- MIDNIGHT ROLLOVER -------- */
  let lastCheckedDate = getDateKey();
  setInterval(()=>{
    const today = getDateKey();
    if(today !== lastCheckedDate){
      lastCheckedDate = today;
      currentTab = today;
      renderTabs();
      renderTracks();
    }
  }, 60_000);

  /* -------- AUTO UPDATE EVERY 5s -------- */
  setInterval(updateDisplay, 5000);
  updateDisplay();
});
</script>

</body>
</html>
